# CampusSync Architecture Documentation

## System Overview

CampusSync is a production-ready, campus-scale digital wallet and dining ecosystem designed for universities with 10,000+ students. The system implements consumption-based billing where students prepay mess fees into a unified wallet and only pay for meals actually consumed.

## Architecture Principles

1. **Scalability**: Designed to handle 10,000+ concurrent users
2. **Security**: End-to-end encryption, audit logs, fraud prevention
3. **Reliability**: Atomic transactions, double-entry accounting
4. **Performance**: Redis caching, optimized queries, connection pooling
5. **Auditability**: Immutable transaction logs, comprehensive audit trails

## System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend Layer                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ Student App  │  │ Vendor UI   │  │ Admin Panel  │       │
│  │  (Mobile)    │  │  (Tablet)    │  │  (Desktop)   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS/REST API
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      Backend API Layer                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ Auth Service │  │ Wallet Svc   │  │ Meal Service │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ QR Service   │  │ Vendor Svc   │  │ Admin Svc    │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ PostgreSQL   │   │    Redis     │   │   Logger     │
│  (Primary)    │   │   (Cache)    │   │  (Winston)   │
└──────────────┘   └──────────────┘   └──────────────┘
```

## Core Components

### 1. Student Wallet System

**Purpose**: Manage student prepaid wallet accounts with real-time balance tracking.

**Key Features**:
- Double-entry accounting (every transaction has credit/debit)
- Atomic balance updates (prevents race conditions)
- Encrypted balance storage
- Transaction history with full audit trail

**Database Tables**:
- `wallets`: Wallet accounts
- `wallet_transactions`: All wallet transactions (immutable)

**Service**: `wallet.service.ts`

### 2. Meal Consumption Flow

**Purpose**: Process meal transactions with consumption-based billing.

**Flow**:
1. Student generates QR code or vendor displays counter QR
2. QR is scanned (student QR at counter OR counter QR from student app)
3. System validates QR (signature, expiration, replay attack prevention)
4. Menu item price is fetched
5. Wallet balance is checked
6. Amount is debited atomically
7. Meal transaction is recorded
8. QR is marked as used

**Key Features**:
- Consumption-based billing (only eaten meals charged)
- Atomic transaction processing
- Real-time balance updates
- Support for both QR scan modes

**Database Tables**:
- `meal_transactions`: Meal consumption records
- `menu_items`: Available meals/items at vendors

**Service**: `meal.service.ts`

### 3. QR Code Payment System

**Purpose**: Generate and validate secure, time-bound QR codes.

**QR Types**:
1. **Student QR**: Generated by student app, shown at counter
2. **Counter QR**: Generated by vendor, scanned by student

**Security Features**:
- HMAC signature validation
- Time-bound expiration (5 minutes default)
- Replay attack prevention (one-time use)
- Redis caching for fast validation

**Database Tables**:
- `qr_codes`: QR code records with usage tracking

**Service**: `qr.service.ts`

### 4. Vendor System

**Purpose**: Manage messes and canteens, track performance, handle settlements.

**Key Features**:
- Unified system for messes and canteens
- Performance metrics and analytics
- Periodic settlement generation
- Menu management

**Database Tables**:
- `vendors`: Vendor information
- `vendor_settlements`: Periodic vendor payments

**Service**: `vendor.service.ts`

### 5. Admin & Accounting System

**Purpose**: System administration, analytics, and vendor settlements.

**Key Features**:
- System-wide analytics
- Meal consumption trends
- Vendor settlement management
- Audit log access
- Exportable reports

**Service**: `admin.routes.ts` (routes only, uses other services)

## Database Schema

### Core Tables

1. **users**: User accounts (students, vendors, admins)
2. **wallets**: Student wallet accounts
3. **wallet_transactions**: Wallet transaction ledger (double-entry)
4. **vendors**: Mess and canteen information
5. **menu_items**: Available meals/items
6. **meal_transactions**: Meal consumption records
7. **qr_codes**: QR code records
8. **topups**: Wallet recharge records
9. **mess_fees**: Initial mess fee payments
10. **vendor_settlements**: Periodic vendor payments
11. **audit_logs**: Immutable audit trail
12. **sessions**: JWT refresh token storage

### Key Relationships

```
users (1) ──→ (1) wallets
wallets (1) ──→ (*) wallet_transactions
users (1) ──→ (*) meal_transactions
vendors (1) ──→ (*) menu_items
vendors (1) ──→ (*) meal_transactions
vendors (1) ──→ (*) vendor_settlements
```

## Security Architecture

### Authentication & Authorization

- **JWT-based authentication**: Access tokens (15 min) + Refresh tokens (7 days)
- **Role-based access control**: student, vendor, admin, super_admin
- **Password hashing**: bcrypt with 12 rounds
- **Session management**: Refresh tokens stored in database

### Data Security

- **Encrypted wallet balances**: AES-256-CBC encryption
- **QR code signatures**: HMAC-SHA256
- **HTTPS only**: All API communication encrypted
- **Rate limiting**: Prevents brute force and DoS attacks

### Fraud Prevention

- **QR expiration**: Time-bound QR codes (5 minutes)
- **Replay attack prevention**: One-time use QR codes
- **Transaction rate limiting**: Max 1 transaction per 10 seconds per user
- **Double-scan prevention**: QR codes marked as used immediately
- **Atomic transactions**: Prevents double-spending

### Audit & Compliance

- **Immutable audit logs**: All critical operations logged
- **Transaction history**: Full ledger with before/after balances
- **Audit triggers**: Automatic logging on wallet/transaction changes

## API Design

### RESTful Principles

- Resource-based URLs
- HTTP methods: GET (read), POST (create), PUT/PATCH (update), DELETE (remove)
- Status codes: 200 (success), 201 (created), 400 (bad request), 401 (unauthorized), 404 (not found), 500 (server error)

### Rate Limiting

- **Standard**: 100 requests per 15 minutes
- **Auth endpoints**: 5 requests per 15 minutes
- **QR scans**: 10 scans per minute
- **Transactions**: 1 transaction per 10 seconds

### Error Handling

- Consistent error response format
- Detailed error messages in development
- Sanitized error messages in production
- Comprehensive logging

## Performance Optimization

### Database

- **Connection pooling**: PostgreSQL connection pool (max 20 connections)
- **Indexes**: Strategic indexes on frequently queried columns
- **Query optimization**: Efficient joins and aggregations
- **Views**: Pre-computed analytics views

### Caching

- **Redis**: Session storage, QR validation cache
- **TTL-based expiration**: Automatic cache invalidation

### Scalability

- **Stateless API**: Horizontal scaling ready
- **Database replication**: Read replicas for analytics
- **CDN ready**: Static assets can be served via CDN

## Deployment Architecture

### Production Setup

```
┌─────────────────────────────────────────────────────────┐
│                    Load Balancer                        │
└─────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ Backend API  │   │ Backend API  │   │ Backend API  │
│  Instance 1  │   │  Instance 2  │   │  Instance N  │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ PostgreSQL   │   │    Redis     │   │   Logger     │
│  Primary     │   │   Cluster    │   │   Service    │
│  + Replicas  │   │              │   │              │
└──────────────┘   └──────────────┘   └──────────────┘
```

### Environment Variables

See `backend/.env.example` for required configuration.

### Monitoring

- **Health checks**: `/health` endpoint
- **Logging**: Winston with file and console transports
- **Error tracking**: Comprehensive error logging
- **Performance metrics**: Transaction times, API response times

## Transaction Flow Example

### Meal Purchase Flow

```
1. Student opens app → Generates student QR (5 min expiry)
2. Student shows QR at vendor counter
3. Vendor scans QR → POST /meals/process
   ├─ Validate QR (signature, expiry, not used)
   ├─ Get menu item price
   ├─ Check wallet balance
   ├─ BEGIN TRANSACTION
   ├─ Debit wallet (atomic)
   ├─ Create meal transaction
   ├─ Mark QR as used
   └─ COMMIT TRANSACTION
4. Response: Transaction details + updated balance
5. Student receives notification (optional)
```

## Future Enhancements

1. **Real-time notifications**: WebSocket support for balance updates
2. **Offline mode**: Queue transactions when offline
3. **Multi-currency support**: Support for different currencies
4. **Loyalty program**: Points and rewards system
5. **Advanced analytics**: ML-based consumption predictions
6. **Mobile apps**: Native iOS/Android apps
7. **Payment gateway integration**: Direct UPI/bank integration



